import{i as u,aa as f,ab as p,g as n,h as o,ac as h}from"./p4dYvpg6.js";import{l as r,D as y}from"./BhIsClV-.js";var m=["forEach","isDisjointFrom","isSubsetOf","isSupersetOf"],v=["difference","intersection","symmetricDifference","union"],d=!1;class g extends Set{#s=new Map;#e=u(0);#t=u(0);#i=f||-1;constructor(e){if(super(),e){for(var t of e)super.add(t);this.#t.v=super.size}d||this.#a()}#r(e){return f===this.#i?u(e):p(e)}#a(){d=!0;var e=g.prototype,t=Set.prototype;for(const i of m)e[i]=function(...s){return n(this.#e),t[i].apply(this,s)};for(const i of v)e[i]=function(...s){n(this.#e);var l=t[i].apply(this,s);return new g(l)}}has(e){var t=super.has(e),i=this.#s,s=i.get(e);if(s===void 0){if(!t)return n(this.#e),!1;s=this.#r(!0),i.set(e,s)}return n(s),t}add(e){return super.has(e)||(super.add(e),o(this.#t,super.size),h(this.#e)),this}delete(e){var t=super.delete(e),i=this.#s,s=i.get(e);return s!==void 0&&(i.delete(e),o(s,!1)),t&&(o(this.#t,super.size),h(this.#e)),t}clear(){if(super.size!==0){super.clear();var e=this.#s;for(var t of e.values())o(t,!1);e.clear(),o(this.#t,0),h(this.#e)}}keys(){return this.values()}values(){return n(this.#e),super.values()}entries(){return n(this.#e),super.entries()}[Symbol.iterator](){return this.keys()}get size(){return n(this.#t)}}class b{constructor(e){this.config=e}state={timerId:null,isExecuting:!1,visibilityHandler:null};get isRunning(){return this.state.timerId!==null}getDisplayName(){return this.config.name??"Polling"}async executeCallback(){const e=this.getDisplayName();if(this.state.isExecuting){r.debug(`[${e}] 前回の実行中のためスキップ`);return}this.state.isExecuting=!0;try{r.debug(`[${e}] コールバック実行中...`),await this.config.callback(),r.info(`[${e}] コールバック完了`)}catch(t){r.error(`[${e}] コールバックエラー:`,t)}finally{this.state.isExecuting=!1}}setupPollingTimer(){this.state.timerId=setInterval(async()=>{await this.executeCallback()},this.config.intervalMs)}start(e){if(this.isRunning){r.debug(`[PollingManager:${this.getDisplayName()}] 既に実行中のためスキップ`);return}const t=this.getDisplayName(),i=this.config.intervalMs/1e3/60;r.info(`[${t}] 開始（間隔: ${i}分）`),e?.immediate&&this.executeCallback(),this.setupPollingTimer()}stop(){this.state.timerId!==null&&(clearInterval(this.state.timerId),this.state.timerId=null,this.state.isExecuting=!1,r.info(`[${this.getDisplayName()}] 停止`))}enableVisibilitySync(){return this.state.visibilityHandler=()=>{document.hidden?this.stop():this.start()},document.addEventListener("visibilitychange",this.state.visibilityHandler),this.start(),()=>{this.stop(),this.state.visibilityHandler&&(document.removeEventListener("visibilitychange",this.state.visibilityHandler),this.state.visibilityHandler=null)}}}function P(a){return new b(a)}class D{constructor(e=P){this.pollingManagerFactory=e}sources=[];activeKeys=new g;pollingManagerInstance=null;registerDataSource(e){if(this.sources.some(t=>t.key===e.key)){r.warn(`[Registry] DataSource '${e.key}' is already registered, skipping`);return}this.sources.push(e),r.debug(`[Registry] Registered: ${e.key}`)}getAllDataSources(){return[...this.sources]}setActiveDataSourceKeys(e){this.activeKeys.clear();for(const t of e)this.activeKeys.add(t);r.debug(`[Registry] Active data sources: ${e.join(", ")}`)}getPollingTargets(){const e=this.sources.filter(t=>t.polling);return this.activeKeys.size===0?e:e.filter(t=>this.activeKeys.has(t.key))}getDataSourceByKey(e){return this.sources.find(t=>t.key===e)}getPollingManager(){if(!this.pollingManagerInstance){const e=this.getMinPollingInterval();this.pollingManagerInstance=this.pollingManagerFactory({intervalMs:e,name:"DataSourcePolling",callback:async()=>{const t=this.getPollingTargets(),i=Date.now(),s=t.filter(l=>i-l.getTimestamp()>=l.pollingInterval);s.length>0&&(r.debug(`[DataSourcePolling] Refreshing ${s.length}/${t.length} sources`),await Promise.all(s.map(l=>l.fetch(!0))))}})}return this.pollingManagerInstance}getMinPollingInterval(){const e=this.getPollingTargets();return e.length===0?y:Math.min(...e.map(t=>t.pollingInterval))}startPolling(){this.getPollingManager().start()}stopPolling(){this.getPollingManager().stop()}enablePollingWithVisibilitySync(){return this.getPollingManager().enableVisibilitySync()}getHealthSummary(){return this.sources.map(e=>{const t=e.getError()!==null,i=e.isCacheValid;let s;return t?s="error":i?s="healthy":s="degraded",{key:e.key,displayName:e.displayName,status:s,lastFetchAt:e.getTimestamp(),isActive:e.isActive,isCacheValid:i}})}reset(){this.sources=[],this.activeKeys.clear(),this.pollingManagerInstance?.stop(),this.pollingManagerInstance=null}}const c=new D;function k(a){c.registerDataSource(a)}function $(a){c.setActiveDataSourceKeys(a)}function E(a){return c.getDataSourceByKey(a)}function K(){c.startPolling()}function w(){c.stopPolling()}export{K as a,w as b,E as g,k as r,$ as s};
