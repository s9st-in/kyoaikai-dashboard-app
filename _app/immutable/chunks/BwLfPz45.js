import{g as B,a as x,R as O,b as K,i as R,M as L,G as Y}from"./7QimJVlU.js";import{g as v,t as A,s as k,a as U}from"./B1sSVCCJ.js";import{l as c,M as b}from"./CyAkH-4i.js";import{i as V,a as H,T as J,D}from"./DCurxu3d.js";import{_ as j,u as q,l as z,s as N,o as W}from"./DGs5A2D8.js";import{s as X}from"./D_zn7YC-.js";import{o as Q}from"./DGrEk6DV.js";import{j as M,g as a,k as Z,u as i}from"./Dj_qSXc_.js";import{g as w,s as ee,a as T,b as _}from"./EUBueQkz.js";import{b as P,d as E,g as te,e as re}from"./Cie8SrI_.js";import{n as u}from"./CCr0WPC9.js";const ne=[{slug:"kyoritsu",defaultKey:"dashboard"},{slug:"reha",defaultKey:"dev-reha-dashboard"}];function ae(e){return ne.find(t=>t.slug===e)}function se(e,t=P){const r=ae(e);if(!r)throw new Error(`No data source mapping found for board '${e}'`);return r.environmentalMappings&&r.environmentalMappings[t]?r.environmentalMappings[t]:r.defaultKey}function ie(e){const t=se(e),r=w(t);if(!r)throw new Error(`DataSource not found for board '${e}' (key: ${t}). Ensure the data source is registered before use.`);return r}function $(e){return e.isDev?"dev":e.source==="external"?"external":"default"}function Be(e){return $(e)}function xe(e){const t=$(e);if(t==="dev")return"DEV";if(t==="external")return"EXT"}function Oe(e,t){return t||e.isDev===!0}function F(e){return{success:!0,data:e}}function f(e){return{success:!1,error:e}}function G(e){if(e)try{const t=JSON.parse(e);if(!Array.isArray(t)){c.warn(`[mappers] environments is not an array, got: ${typeof t}`,{environments:e});return}if(!t.every(r=>typeof r=="string")){c.warn("[mappers] environments contains non-string elements",{environments:e});return}return t}catch(t){c.warn("[mappers] Failed to parse environments JSON",{environments:e,error:t});return}}function oe(e){try{if(!e.slug||!e.label)return f(v("validation","Invalid metric row: missing required fields (slug or label)",`slug: ${e.slug}, label: ${e.label}`));const t=B(e.formatterType,e.denominatorValue);if(!t)return f(v("validation",`Invalid formatter type: ${e.formatterType}`,`slug: ${e.slug}`));const r={id:e.slug,title:e.label,dataKey:e.dataKey,formatter:t,unit:e.unit,unitPrefix:e.unitPrefix,order:e.displayOrder,source:e.source??void 0,isDev:e.isDev,environments:G(e.environments),timeGranularity:e.timeGranularity};return F(r)}catch(t){return f(A(t,"Failed to map MetricDefinition row",`slug: ${e.slug}`))}}function le(e){try{if(!e.graphId||!e.label)return f(v("validation","Invalid graph row: missing required fields (graphId or label)",`graphId: ${e.graphId}, label: ${e.label}`));const t=x(e.colorName);if(!t)return f(v("validation",`Invalid color name: ${e.colorName}`,`graphId: ${e.graphId}`));const r=e.graphTitle??e.label,n=e.transformMultiplier,s=n?g=>g*n:void 0,d={order:e.displayOrder,id:e.graphId,title:r,dataKey:e.dataKey,color:e.colorName,chartColors:t,unit:e.unit,maxY:e.maxY??void 0,transform:s,decimalPlaces:e.decimalPlaces,source:e.source??void 0,isDev:e.isDev,environments:G(e.environments)};return F(d)}catch(t){return f(A(t,"Failed to map GraphDefinition row",`graphId: ${e.graphId}`))}}const ue={resolve(e){const t=e.metricDefinitions.map(oe),r=t.filter(n=>!n.success);return r.length>0&&c.warn("Metric mapping errors",{count:r.length,errors:r.map(n=>n.success?null:n.error)}),t.filter(n=>n.success).map(n=>n.data)}},ce={resolve(e){const t=e.graphDefinitions.map(le),r=t.filter(n=>!n.success);return r.length>0&&c.warn("Graph mapping errors",{count:r.length,errors:r.map(n=>n.success?null:n.error)}),t.filter(n=>n.success).map(n=>n.data)}},de={resolve(){return K}},fe={resolve(){return O}},I=new Map;function ge(e,t){I.set(e,t)}function y(e){return I.get(e)?.metric??ue}function S(e){return I.get(e)?.graph??ce}ge("reha",{metric:de,graph:fe});function Ke(e){const t=y(e.slug)!==y("__nonexistent__")?e.slug:"default";try{return y(e.slug).resolve({metricDefinitions:e.metricDefinitions,graphDefinitions:e.graphDefinitions}).filter(s=>R(s.id,L)).filter(V)}catch(r){throw c.error(`[resolveMetrics] Failed to resolve metrics (slug: ${e.slug}, resolver: ${t})`,r),r}}function Le(e){const t=S(e.slug)!==S("__nonexistent__")?e.slug:"default";try{return S(e.slug).resolve({metricDefinitions:e.metricDefinitions,graphDefinitions:e.graphDefinitions}).filter(s=>R(s.id,Y)).filter(H)}catch(r){throw c.error(`[resolveGraphs] Failed to resolve graphs (slug: ${e.slug}, resolver: ${t})`,r),r}}const me=j(J).catch(D).default(D),pe=q([z("latest"),N().regex(/^\d{4}-\d{2}-\d{2}$/,"日付はYYYY-MM-DD形式である必要があります").refine(e=>{const t=new Date(e);if(isNaN(t.getTime()))return!1;const[r,n,s]=e.split("-").map(Number);return t.getFullYear()===r&&t.getMonth()===n-1&&t.getDate()===s},{message:"有効な日付ではありません"})]).catch("latest").default("latest"),he=N().nullable().catch(null).default(null),ve=W({tab:me,metricId:he,date:pe});function Ye(e){const t={tab:e.get("tab"),metricId:e.get("metric-id"),date:e.get("date")},r=ve.safeParse(t);return r.success?r.data:{tab:D,metricId:null,date:"latest"}}function ke(e){return e.tab!==D&&e.metricId!==null?{...e,metricId:null}:e}function Ue(e,t){const r=new URLSearchParams(t);return e.tab!==void 0&&r.set("tab",e.tab),e.metricId!==void 0&&(e.metricId===null?r.delete("metric-id"):r.set("metric-id",e.metricId)),e.date!==void 0&&(e.date==="latest"?r.delete("date"):r.set("date",e.date)),r}X.updated.check;function Ve(e){const t=i(()=>ie(e.slug)),r=i(()=>a(t).getData()),n=i(()=>a(t).isLoading()),s=i(()=>a(t).getError()),d=i(()=>a(t).getTimestamp()),g=i(()=>a(d)?new Date(a(d)).toLocaleString("ja-JP"):""),p=i(()=>a(t).isDummy||P==="development"),h=i(()=>a(r)!==null&&a(s)!==null);let m=null;M(()=>{const o=a(t);return Z(()=>{const C=m!==null&&m!==o;m=o,C&&(e.onSlugChange?.(),o.clear(),o.fetch(!0)),o.activate()}),()=>{o.deactivate()}}),M(()=>{const o=[a(t).key,k.key,U.key];ee(o)}),Q(()=>{T();function o(){document.hidden?_():T()}return document.addEventListener("visibilitychange",o),()=>{_(),document.removeEventListener("visibilitychange",o)}});async function l(){await a(t).fetch(!0)}return{get dashboardData(){return a(r)},get isLoading(){return a(n)},get error(){return a(s)},get lastUpdatedText(){return a(g)},get devMode(){return a(p)},get hasStaleData(){return a(h)},retryFetch:l}}function De(e,t,r){if(!e?.length)return null;const n=e.find(s=>s?.日付&&u(s.日付)===t);if(n&&u(n.日付)>=r)return n;for(let s=e.length-1;s>=0;s--)if(e[s]?.日付&&u(e[s].日付)>=r)return e[s];return null}function ye(e,t){return e?.日付?u(e.日付)===t:!1}function Se(e,t,r){if(!e?.length)return null;const n=e.find(s=>s?.日付&&u(s.日付)===t);if(n&&u(n.日付)>=r)return n;for(let s=e.length-1;s>=0;s--)if(e[s]?.日付&&u(e[s].日付)>=r)return e[s];return null}function Ie(e,t){return e?.日付?u(e.日付)===t:!1}function be(e,t){return t===null||!e?.length?null:e[t]??null}function Me(e,t){return e?E(new Date(e)):t?.日付?E(new Date(t.日付)):null}function He(e){const t=i(re),r=i(()=>{const{dashboardData:l}=e();return De(l,a(t),b)}),n=i(()=>ye(a(r),a(t))),s=i(()=>{const{dashboardData:l,effectiveIndex:o}=e();return be(l,o)}),d=i(()=>{const{selectedDate:l}=e();return Me(l,a(s))}),g=i(()=>a(s)!==null),p=i(te),h=i(()=>{const{dashboardData:l}=e();return Se(l,a(p),b)}),m=i(()=>Ie(a(h),a(p)));return{get boardDisplayData(){return a(r)},get boardIsShowingYesterday(){return a(n)},get sinageDisplayData(){return a(h)},get sinageIsShowingToday(){return a(m)},get dataDisplayData(){return a(s)},get formattedSelectedDate(){return a(d)},get hasDataForSelectedDate(){return a(g)}}}function Je(e){return e.toSorted((t,r)=>t.order-r.order)}export{me as T,Le as a,He as b,xe as c,Oe as d,Be as g,ke as n,Ye as p,Ke as r,Je as s,Ue as t,Ve as u};
