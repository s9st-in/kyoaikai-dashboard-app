import{g as L,R as O,f as K,i as _,M as Y,G as k}from"./aTZK_S6W.js";import{g as x}from"./Bq9a2B43.js";import{a as v,t as A}from"./DiPxs-5a.js";import{l as c,M as I}from"./BhIsClV-.js";import{i as N,T as U,D}from"./C3ChFxzh.js";import{j as y,b as V,e as j,k as b,m as H,n as J}from"./OQgd7Oh0.js";import{_ as q,u as z,l as W,s as P,o as X}from"./DGs5A2D8.js";import"./P7rPqgRT.js";import{s as Q}from"./CM1W8w0u.js";import{o as Z}from"./T2Bmc5lN.js";import{j as M,g as a,o as w,u as i}from"./p4dYvpg6.js";import{g as ee,s as te,a as T,b as E}from"./D2WUQr3a.js";import{p as R,n as u}from"./CS60pbwF.js";const re=[{slug:"kyoritsu",defaultKey:"dashboard"},{slug:"reha",defaultKey:"dev-reha-dashboard"}];function ne(e){return re.find(t=>t.slug===e)}function ae(e,t=y){const r=ne(e);if(!r)throw new Error(`No data source mapping found for board '${e}'`);return r.environmentalMappings&&r.environmentalMappings[t]?r.environmentalMappings[t]:r.defaultKey}function se(e){const t=ae(e),r=ee(t);if(!r)throw new Error(`DataSource not found for board '${e}' (key: ${t}). Ensure the data source is registered before use.`);return r}function $(e){return e.isDev?"dev":e.source==="external"?"external":"default"}function Ke(e){return $(e)}function Ye(e){const t=$(e);if(t==="dev")return"DEV";if(t==="external")return"EXT"}function ke(e,t){return t||e.isDev===!0}function F(e){return{success:!0,data:e}}function f(e){return{success:!1,error:e}}function C(e){if(e)try{const t=JSON.parse(e);if(!Array.isArray(t)){c.warn(`[mappers] environments is not an array, got: ${typeof t}`,{environments:e});return}if(!t.every(r=>typeof r=="string")){c.warn("[mappers] environments contains non-string elements",{environments:e});return}return t}catch(t){c.warn("[mappers] Failed to parse environments JSON",{environments:e,error:t});return}}function ie(e){try{if(!e.slug||!e.label)return f(v("validation","Invalid metric row: missing required fields (slug or label)",`slug: ${e.slug}, label: ${e.label}`));const t=L(e.formatterType,e.denominatorValue);if(!t)return f(v("validation",`Invalid formatter type: ${e.formatterType}`,`slug: ${e.slug}`));const r={id:e.slug,title:e.label,dataKey:e.dataKey,formatter:t,unit:e.unit,unitPrefix:e.unitPrefix,order:e.displayOrder,source:e.source??void 0,isDev:e.isDev,environments:C(e.environments),timeGranularity:e.timeGranularity};return F(r)}catch(t){return f(A(t,"Failed to map MetricDefinition row",`slug: ${e.slug}`))}}function oe(e){try{if(!e.graphId||!e.label)return f(v("validation","Invalid graph row: missing required fields (graphId or label)",`graphId: ${e.graphId}, label: ${e.label}`));const t=x(e.colorName);if(!t)return f(v("validation",`Invalid color name: ${e.colorName}`,`graphId: ${e.graphId}`));const r=e.graphTitle??e.label,n=e.transformMultiplier,s=n?g=>g*n:void 0,d={order:e.displayOrder,id:e.graphId,title:r,dataKey:e.dataKey,color:e.colorName,chartColors:t,unit:e.unit,maxY:e.maxY??void 0,transform:s,decimalPlaces:e.decimalPlaces,source:e.source??void 0,isDev:e.isDev,environments:C(e.environments)};return F(d)}catch(t){return f(A(t,"Failed to map GraphDefinition row",`graphId: ${e.graphId}`))}}const le={resolve(e){const t=e.metricDefinitions.map(ie),r=t.filter(n=>!n.success);return r.length>0&&c.warn("Metric mapping errors",{count:r.length,errors:r.map(n=>n.success?null:n.error)}),t.filter(n=>n.success).map(n=>n.data)}},ue={resolve(e){const t=e.graphDefinitions.map(oe),r=t.filter(n=>!n.success);return r.length>0&&c.warn("Graph mapping errors",{count:r.length,errors:r.map(n=>n.success?null:n.error)}),t.filter(n=>n.success).map(n=>n.data)}},ce={resolve(e){return K}},de={resolve(e){return O}},S=new Map;function fe(e,t){S.set(e,t)}function ge(e){return S.get(e)?.metric??le}function me(e){return S.get(e)?.graph??ue}function G(e){return S.has(e)}fe("reha",{metric:ce,graph:de});function xe(e){const t=G(e.slug)?e.slug:"default";try{return ge(e.slug).resolve({metricDefinitions:e.metricDefinitions,graphDefinitions:e.graphDefinitions}).filter(n=>_(n.id,Y)).filter(n=>N(n,y))}catch(r){throw c.error(`[resolveMetrics] Failed to resolve metrics (slug: ${e.slug}, resolver: ${t})`,r),r}}function Ue(e){const t=G(e.slug)?e.slug:"default";try{return me(e.slug).resolve({metricDefinitions:e.metricDefinitions,graphDefinitions:e.graphDefinitions}).filter(n=>_(n.id,k)).filter(n=>N(n,y))}catch(r){throw c.error(`[resolveGraphs] Failed to resolve graphs (slug: ${e.slug}, resolver: ${t})`,r),r}}const pe=q(U).catch(D).default(D),he=z([W("latest"),P().regex(/^\d{4}-\d{2}-\d{2}$/,"日付はYYYY-MM-DD形式である必要があります").refine(e=>{const t=new Date(e);if(isNaN(t.getTime()))return!1;const[r,n,s]=e.split("-").map(Number);return t.getFullYear()===r&&t.getMonth()===n-1&&t.getDate()===s},{message:"有効な日付ではありません"})]).catch("latest").default("latest"),ve=P().nullable().catch(null).default(null),De=X({tab:pe,metricId:ve,date:he});function Ve(e){const t={tab:e.get("tab"),metricId:e.get("metric-id"),date:e.get("date")},r=De.safeParse(t);return r.success?r.data:{tab:D,metricId:null,date:"latest"}}function je(e){return e.tab!==D&&e.metricId!==null?{...e,metricId:null}:e}function He(e,t){const r=new URLSearchParams(t);return e.tab!==void 0&&r.set("tab",e.tab),e.metricId!==void 0&&(e.metricId===null?r.delete("metric-id"):r.set("metric-id",e.metricId)),e.date!==void 0&&(e.date==="latest"?r.delete("date"):r.set("date",e.date)),r}Q.updated.check;function Je(e){const t=i(()=>se(e.slug)),r=i(()=>a(t).getData()),n=i(()=>a(t).isLoading()),s=i(()=>a(t).getError()),d=i(()=>a(t).getTimestamp()),g=i(()=>a(d)?new Date(a(d)).toLocaleString("ja-JP"):""),p=i(()=>a(t).isDummy||y==="development"),h=i(()=>a(r)!==null&&a(s)!==null);let m=null;M(()=>{const o=a(t);return w(()=>{const B=m!==null&&m!==o;m=o,B&&(e.onSlugChange?.(),o.clear(),o.fetch(!0)),o.activate()}),()=>{o.deactivate()}}),M(()=>{const o=[a(t).key,V.key,j.key];te(o)}),Z(()=>{T();function o(){document.hidden?E():T()}return document.addEventListener("visibilitychange",o),()=>{E(),document.removeEventListener("visibilitychange",o)}});async function l(){await a(t).fetch(!0)}return{get dashboardData(){return a(r)},get isLoading(){return a(n)},get error(){return a(s)},get lastUpdatedText(){return a(g)},get devMode(){return a(p)},get hasStaleData(){return a(h)},retryFetch:l}}function ye(e,t,r){if(!e?.length)return null;const n=e.find(s=>s?.日付&&u(s.日付)===t);if(n&&u(n.日付)>=r)return n;for(let s=e.length-1;s>=0;s--)if(e[s]?.日付&&u(e[s].日付)>=r)return e[s];return null}function Se(e,t){return e?.日付?u(e.日付)===t:!1}function Ie(e,t,r){if(!e?.length)return null;const n=e.find(s=>s?.日付&&u(s.日付)===t);if(n&&u(n.日付)>=r)return n;for(let s=e.length-1;s>=0;s--)if(e[s]?.日付&&u(e[s].日付)>=r)return e[s];return null}function be(e,t){return e?.日付?u(e.日付)===t:!1}function Me(e,t){return t===null||!e?.length?null:e[t]??null}function Te(e,t){if(e){const r=R(e);return r?b(r):null}if(t?.日付){const r=R(t.日付);return r?b(r):null}return null}function qe(e){const t=i(J),r=i(()=>{const{dashboardData:l}=e();return ye(l,a(t),I)}),n=i(()=>Se(a(r),a(t))),s=i(()=>{const{dashboardData:l,effectiveIndex:o}=e();return Me(l,o)}),d=i(()=>{const{selectedDate:l}=e();return Te(l,a(s))}),g=i(()=>a(s)!==null),p=i(H),h=i(()=>{const{dashboardData:l}=e();return Ie(l,a(p),I)}),m=i(()=>be(a(h),a(p)));return{get boardDisplayData(){return a(r)},get boardIsShowingYesterday(){return a(n)},get sinageDisplayData(){return a(h)},get sinageIsShowingToday(){return a(m)},get dataDisplayData(){return a(s)},get formattedSelectedDate(){return a(d)},get hasDataForSelectedDate(){return a(g)}}}function ze(e){return e.toSorted((t,r)=>t.order-r.order)}export{pe as T,Ue as a,qe as b,Ye as c,ke as d,Ke as g,je as n,Ve as p,xe as r,ze as s,He as t,Je as u};
